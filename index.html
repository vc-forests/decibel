<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decibel</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h3>Project decibel</h3>
    <button id="startMicrophoneBtn" type="button">Start using microphone</button>
    <button id="stopMicrophoneBtn" type="button">Stop using microphone</button>
    <script>
        const startMicrophoneBtn = document.getElementById('startMicrophoneBtn');
        const context = new AudioContext();
        startMicrophoneBtn.addEventListener('click', async function () {
            await initializeAudio()
        }, { once: true });
        async function initializeAudio() {
            // autoplay policy
            if (context.state == "suspended") {
                await context.resume();
            }
            const micStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: false,
                    autoGainControl: false,
                    noiseSuppression: false,
                    latency: 0
                }
            })
            // source audio node but for media stream (microphone)
            const micSourceNode = context.createMediaStreamSource(micStream);
            // audio node to adjsut volumne
            const gainNode = new GainNode(context);
            // audio node to analyze audio (frequency analysis)
            const analyserNode = new AnalyserNode(context);
            const recordingProperties = {
                numberOfChannels: micSourceNode.channelCount,
                sampleRate: context.sampleRate,
                maxFrameCount: context.sampleRate * 300
            };
            const recordingNode = await setupRecordingWorkletNode(recordingProperties);
            micSourceNode.connect(recordingNode).connect(context.destination);
        }

        async function setupRecordingWorkletNode(recordingProperties) {
            await context.audioWorklet.addModule('recording-processor.js');
            const workletRecordingNode = new AudioWorkletNode(context, 'recording-processor', {
                processorOptions: recordingProperties
            });
            return workletRecordingNode;
        }
    </script>
</body>

</html>